<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test du Gestionnaire d'Images FloDrama</title>
  <style>
    :root {
      --blue-signature: #3b82f6;
      --fuchsia-accent: #d946ef;
      --background-dark: #121118;
      --background-secondary: #1A1926;
      --text-light: #f8fafc;
      --text-secondary: #94a3b8;
      --gradient-signature: linear-gradient(to right, #3b82f6, #d946ef);
    }
    
    body {
      background-color: var(--background-dark);
      color: var(--text-light);
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2 {
      background: var(--gradient-signature);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    
    .test-section {
      background-color: var(--background-secondary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .image-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .image-card:hover {
      transform: translateY(-5px);
    }
    
    .image-container {
      position: relative;
      aspect-ratio: 2/3;
      overflow: hidden;
    }
    
    .test-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-info {
      padding: 10px;
    }
    
    .image-title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .image-source {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
      word-break: break-all;
    }
    
    .control-panel {
      background-color: var(--background-secondary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .button {
      background: var(--gradient-signature);
      border: none;
      border-radius: 4px;
      color: white;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    
    .button:hover {
      opacity: 0.9;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-online {
      background-color: #10b981;
    }
    
    .status-offline {
      background-color: #ef4444;
    }
    
    .cdn-status {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    
    .cdn-item {
      display: flex;
      align-items: center;
    }
    
    .log-container {
      background-color: #1e1e2d;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      line-height: 1.4;
    }
    
    .log-info {
      color: #3b82f6;
    }
    
    .log-warn {
      color: #f59e0b;
    }
    
    .log-error {
      color: #ef4444;
    }
    
    .log-debug {
      color: #94a3b8;
    }
    
    /* Styles pour les fallbacks d'images */
    .fallback-image.poster-fallback {
      background: linear-gradient(135deg, #3b82f6, #d946ef);
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test du Gestionnaire d'Images FloDrama</h1>
    
    <div class="control-panel">
      <h2>Panneau de contrôle</h2>
      
      <div class="cdn-status">
        <div class="cdn-item">
          <span class="status-indicator" id="bunny-status"></span>
          <span>Bunny CDN</span>
        </div>
        <div class="cdn-item">
          <span class="status-indicator" id="cloudfront-status"></span>
          <span>CloudFront</span>
        </div>
        <div class="cdn-item">
          <span class="status-indicator" id="github-status"></span>
          <span>GitHub Pages</span>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <button class="button" id="simulate-error">Simuler des erreurs</button>
        <button class="button" id="reset-images">Réinitialiser</button>
        <button class="button" id="preload-images">Précharger</button>
        <button class="button" id="toggle-bunny">Désactiver Bunny CDN</button>
        <button class="button" id="toggle-cloudfront">Désactiver CloudFront</button>
        <button class="button" id="clear-logs">Effacer les logs</button>
      </div>
      
      <div class="log-container" id="log-container">
        <div class="log-entry log-info">Initialisation du système de test...</div>
      </div>
    </div>
    
    <div class="test-section">
      <h2>Test des images de posters</h2>
      <div class="test-grid" id="poster-grid">
        <!-- Les cartes d'images seront générées ici -->
      </div>
    </div>
    
    <div class="test-section">
      <h2>Test des images de backdrops</h2>
      <div class="test-grid" id="backdrop-grid">
        <!-- Les cartes d'images seront générées ici -->
      </div>
    </div>
  </div>
  
  <script type="module">
    // Importer le gestionnaire d'images
    import { initImageManager, handleImageError, preloadImage, getOptimalImageUrl, ImageTypes } from './src/utils/imageManager.js';
    
    // Configuration du test
    const TEST_CONTENT_IDS = {
      posters: ['drama001', 'drama002', 'drama003', 'drama004', 'drama005', 'drama006'],
      backdrops: ['backdrop001', 'backdrop002', 'backdrop003', 'backdrop004']
    };
    
    // État des CDNs pour la simulation
    const cdnStatus = {
      bunny: true,
      cloudfront: true,
      github: true
    };
    
    // Système de logs
    const logger = {
      container: document.getElementById('log-container'),
      
      log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        this.container.appendChild(entry);
        this.container.scrollTop = this.container.scrollHeight;
        
        // Limiter le nombre de logs affichés
        if (this.container.children.length > 100) {
          this.container.removeChild(this.container.children[0]);
        }
      },
      
      info(message) {
        this.log(message, 'info');
        console.info(message);
      },
      
      warn(message) {
        this.log(message, 'warn');
        console.warn(message);
      },
      
      error(message) {
        this.log(message, 'error');
        console.error(message);
      },
      
      debug(message) {
        this.log(message, 'debug');
        console.debug(message);
      },
      
      clear() {
        this.container.innerHTML = '';
      }
    };
    
    // Fonction pour créer une carte d'image
    function createImageCard(contentId, type, container) {
      const card = document.createElement('div');
      card.className = 'image-card';
      
      const imageContainer = document.createElement('div');
      imageContainer.className = 'image-container';
      
      const img = document.createElement('img');
      img.className = 'test-image';
      img.alt = `${type} ${contentId}`;
      img.dataset.contentId = contentId;
      img.dataset.type = type;
      
      // Définir l'URL de l'image
      const imageUrl = getOptimalImageUrl(contentId, type);
      img.src = imageUrl;
      
      // Ajouter un gestionnaire d'erreur
      img.onerror = (e) => handleImageError(e);
      
      const info = document.createElement('div');
      info.className = 'image-info';
      
      const title = document.createElement('h3');
      title.className = 'image-title';
      title.textContent = `${type} ${contentId}`;
      
      const source = document.createElement('div');
      source.className = 'image-source';
      source.textContent = imageUrl;
      
      // Assembler la carte
      imageContainer.appendChild(img);
      info.appendChild(title);
      info.appendChild(source);
      card.appendChild(imageContainer);
      card.appendChild(info);
      
      container.appendChild(card);
      
      return img;
    }
    
    // Fonction pour mettre à jour les indicateurs de statut
    function updateStatusIndicators() {
      document.getElementById('bunny-status').className = `status-indicator ${cdnStatus.bunny ? 'status-online' : 'status-offline'}`;
      document.getElementById('cloudfront-status').className = `status-indicator ${cdnStatus.cloudfront ? 'status-online' : 'status-offline'}`;
      document.getElementById('github-status').className = `status-indicator ${cdnStatus.github ? 'status-online' : 'status-offline'}`;
    }
    
    // Fonction pour simuler une erreur de chargement d'image
    function simulateImageError() {
      logger.info('Simulation d\'erreurs de chargement d\'images');
      
      // Sélectionner toutes les images
      const images = document.querySelectorAll('.test-image');
      
      // Simuler une erreur pour chaque image
      images.forEach(img => {
        // Déclencher artificiellement l'événement d'erreur
        const errorEvent = new Event('error');
        img.dispatchEvent(errorEvent);
      });
    }
    
    // Fonction pour réinitialiser les images
    function resetImages() {
      logger.info('Réinitialisation des images');
      
      // Vider les grilles
      document.getElementById('poster-grid').innerHTML = '';
      document.getElementById('backdrop-grid').innerHTML = '';
      
      // Recréer les images
      initializeTestImages();
    }
    
    // Fonction pour précharger les images
    async function preloadTestImages() {
      logger.info('Préchargement des images...');
      
      try {
        // Précharger les posters
        for (const contentId of TEST_CONTENT_IDS.posters) {
          const url = await preloadImage(contentId, ImageTypes.POSTER);
          logger.debug(`Préchargé: ${contentId} (poster) -> ${url}`);
        }
        
        // Précharger les backdrops
        for (const contentId of TEST_CONTENT_IDS.backdrops) {
          const url = await preloadImage(contentId, ImageTypes.BACKDROP);
          logger.debug(`Préchargé: ${contentId} (backdrop) -> ${url}`);
        }
        
        logger.info('Préchargement terminé');
      } catch (error) {
        logger.error(`Erreur de préchargement: ${error.message}`);
      }
    }
    
    // Fonction pour basculer l'état d'un CDN
    function toggleCdnStatus(cdn) {
      cdnStatus[cdn] = !cdnStatus[cdn];
      logger.info(`${cdn} CDN est maintenant ${cdnStatus[cdn] ? 'activé' : 'désactivé'}`);
      updateStatusIndicators();
    }
    
    // Fonction pour initialiser les images de test
    function initializeTestImages() {
      const posterGrid = document.getElementById('poster-grid');
      const backdropGrid = document.getElementById('backdrop-grid');
      
      // Créer les cartes de posters
      for (const contentId of TEST_CONTENT_IDS.posters) {
        createImageCard(contentId, ImageTypes.POSTER, posterGrid);
      }
      
      // Créer les cartes de backdrops
      for (const contentId of TEST_CONTENT_IDS.backdrops) {
        createImageCard(contentId, ImageTypes.BACKDROP, backdropGrid);
      }
      
      logger.info('Images de test initialisées');
    }
    
    // Initialiser l'application de test
    function initializeApp() {
      // Initialiser le gestionnaire d'images
      initImageManager();
      
      // Initialiser les images de test
      initializeTestImages();
      
      // Mettre à jour les indicateurs de statut
      updateStatusIndicators();
      
      // Ajouter les écouteurs d'événements pour les boutons
      document.getElementById('simulate-error').addEventListener('click', simulateImageError);
      document.getElementById('reset-images').addEventListener('click', resetImages);
      document.getElementById('preload-images').addEventListener('click', preloadTestImages);
      document.getElementById('toggle-bunny').addEventListener('click', () => toggleCdnStatus('bunny'));
      document.getElementById('toggle-cloudfront').addEventListener('click', () => toggleCdnStatus('cloudfront'));
      document.getElementById('clear-logs').addEventListener('click', () => logger.clear());
      
      logger.info('Application de test initialisée');
    }
    
    // Démarrer l'application au chargement de la page
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
