name: CI/CD FloDrama Optimis√©

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      update_lambda:
        description: 'Mettre √† jour la fonction Lambda'
        required: false
        default: false
        type: boolean

# Permissions n√©cessaires pour GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

env:
  S3_BUCKET: flodrama-assets
  AWS_REGION: eu-west-3
  LAMBDA_FUNCTION_NAME: FloDramaImageOptimizer
  IAM_ROLE_NAME: LambdaS3Role

jobs:
  # Job de d√©ploiement du contenu
  deploy_content:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Installation des d√©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install boto3 requests pillow

      - name: Configuration AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
          role-session-name: GitHubActionsSession
      
      # V√©rification du bucket S3 avant toute op√©ration
      - name: V√©rification du bucket S3
        id: check-s3-bucket
        run: |
          echo "üîç V√©rification du bucket S3 ${{ env.S3_BUCKET }}..."
          
          if aws s3api head-bucket --bucket ${{ env.S3_BUCKET }} 2>/dev/null; then
            echo "‚úÖ Le bucket S3 ${{ env.S3_BUCKET }} existe."
            echo "BUCKET_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Le bucket S3 ${{ env.S3_BUCKET }} n'existe pas."
            echo "BUCKET_EXISTS=false" >> $GITHUB_OUTPUT
          fi

      # Cr√©ation du bucket S3 s'il n'existe pas
      - name: Cr√©ation du bucket S3
        if: steps.check-s3-bucket.outputs.BUCKET_EXISTS == 'false'
        run: |
          echo "üîß Cr√©ation du bucket S3 ${{ env.S3_BUCKET }}..."
          
          aws s3api create-bucket \
            --bucket ${{ env.S3_BUCKET }} \
            --region ${{ env.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }}
          
          # Configuration du bucket pour l'h√©bergement web statique
          aws s3 website s3://${{ env.S3_BUCKET }}/ --index-document index.html --error-document error.html
          
          # Configuration des permissions CORS
          aws s3api put-bucket-cors --bucket ${{ env.S3_BUCKET }} --cors-configuration '{
            "CORSRules": [
              {
                "AllowedHeaders": ["*"],
                "AllowedMethods": ["GET", "HEAD"],
                "AllowedOrigins": ["*"],
                "ExposeHeaders": [],
                "MaxAgeSeconds": 3000
              }
            ]
          }'
          
          echo "‚úÖ Bucket S3 cr√©√© et configur√© avec succ√®s."

      # G√©n√©ration des donn√©es de contenu
      - name: G√©n√©ration des donn√©es de contenu
        run: |
          echo "üîÑ G√©n√©ration des donn√©es de contenu..."
          
          # V√©rification de l'existence des scripts
          echo "üìÇ Contenu du r√©pertoire scripts/"
          ls -la scripts/
          
          # Cr√©ation du dossier d'export
          mkdir -p export_data
          
          # Ex√©cution du script de g√©n√©ration de donn√©es
          echo "üîÑ Utilisation du script generate_demo_data.py..."
          python scripts/generate_demo_data.py
          
          # V√©rification des fichiers g√©n√©r√©s
          echo "üìÇ Contenu du dossier export_data/"
          ls -la export_data/
          
          echo "‚úÖ Donn√©es g√©n√©r√©es avec succ√®s."

      # Synchronisation avec S3 uniquement si le bucket existe
      - name: Synchronisation avec S3
        if: steps.check-s3-bucket.outputs.BUCKET_EXISTS == 'true'
        run: |
          echo "üîÑ Synchronisation des donn√©es avec S3..."
          
          # Cr√©ation du dossier data s'il n'existe pas
          aws s3api put-object --bucket ${{ env.S3_BUCKET }} --key data/ --content-type "application/x-directory" || true
          
          # Synchronisation des donn√©es
          aws s3 sync export_data/ s3://${{ env.S3_BUCKET }}/data/ --cache-control "max-age=3600"
          
          echo "‚úÖ Synchronisation termin√©e."

      # G√©n√©ration et upload du fichier de contenu agr√©g√©
      - name: G√©n√©ration du contenu agr√©g√©
        if: steps.check-s3-bucket.outputs.BUCKET_EXISTS == 'true'
        run: |
          echo "üîÑ G√©n√©ration du contenu agr√©g√©..."
          
          # Ex√©cution du script d'agr√©gation de contenu
          echo "üîÑ Utilisation du script aggregate_content.py..."
          python scripts/aggregate_content.py
          
          # Upload du fichier agr√©g√©
          aws s3 cp export_data/all_content.json s3://${{ env.S3_BUCKET }}/data/all_content.json --cache-control "max-age=3600"
          
          echo "‚úÖ Contenu agr√©g√© g√©n√©r√© et upload√©."

      # Invalidation du cache CloudFront si l'ID est configur√©
      - name: Invalidation du cache CloudFront
        if: steps.check-s3-bucket.outputs.BUCKET_EXISTS == 'true'
        run: |
          echo "üîÑ V√©rification de la distribution CloudFront..."
          
          if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            echo "üîÑ Invalidation du cache CloudFront..."
            
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --paths "/data/*"
            
            echo "‚úÖ Invalidation du cache CloudFront initi√©e."
          else
            echo "‚ö†Ô∏è Aucun ID CloudFront configur√©, invalidation ignor√©e."
          fi
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

  # Job de d√©ploiement du frontend
  deploy_frontend:
    runs-on: ubuntu-latest
    needs: deploy_content
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json
      
      - name: Construction du frontend
        working-directory: ./Frontend
        run: |
          echo "üì¶ Installation des d√©pendances..."
          npm install --legacy-peer-deps
          
          echo "üîë Configuration des variables d'environnement..."
          if [ -f ".env.production" ]; then
            cp .env.production .env
          else
            echo "‚ö†Ô∏è Fichier .env.production non trouv√©, cr√©ation d'un fichier .env par d√©faut..."
            echo "REACT_APP_API_URL=https://flodrama-cors-proxy.onrender.com/api" > .env
          fi
          
          echo "üöÄ Construction de l'application React..."
          npm run build
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Construction du frontend r√©ussie!"
          else
            echo "‚ùå √âchec de la construction du frontend."
            # Cr√©ation d'une page d'attente simple
            mkdir -p dist
            echo "<html><head><title>FloDrama - Site en maintenance</title></head><body style='background:#121118;color:white;font-family:sans-serif;text-align:center;padding-top:50px;'><h1 style='color:#3b82f6;'>FloDrama</h1><p>Site en cours de d√©ploiement - Merci de votre patience</p></body></html>" > dist/index.html
            echo "‚ö†Ô∏è Page d'attente cr√©√©e"
          fi

      - name: Installation de Surge
        run: npm install -g surge

      - name: D√©ploiement sur flodrama.com
        run: |
          echo "üöÄ D√©ploiement sur flodrama.com..."
          cd Frontend/dist
          if [ ! -d "dist" ] && [ -d "build" ]; then
            cd build
          fi
          surge --project ./ --domain flodrama.com --token ${{ secrets.SURGE_TOKEN }}
          echo "‚úÖ Frontend d√©ploy√© avec succ√®s sur https://flodrama.com"

  # Job de d√©ploiement du proxy
  deploy_proxy:
    runs-on: ubuntu-latest
    needs: [deploy_frontend]
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Installation des d√©pendances du proxy
        run: |
          npm install express cors axios

      - name: Copie des fichiers du proxy vers le serveur
        run: |
          mkdir -p proxy-deploy
          cp Frontend/api-proxy-server.js proxy-deploy/server.js
          cp package.json proxy-deploy/
          cp -r Frontend/dist proxy-deploy/dist
      
      - name: Pr√©paration du package.json pour le proxy
        run: |
          cat > proxy-deploy/package.json << EOF
          {
            "name": "flodrama-api-proxy",
            "version": "1.0.0",
            "description": "Proxy API pour FloDrama",
            "main": "server.js",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "express": "^4.18.2",
              "cors": "^2.8.5",
              "axios": "^1.6.0"
            },
            "engines": {
              "node": "18.x"
            }
          }
          EOF
          
      - name: D√©ploiement du proxy sur Heroku (si disponible)
        if: false  # D√©sactiv√© temporairement - Activer quand Heroku est configur√©
        run: |
          # Commandes pour d√©ployer sur Heroku (√† activer plus tard)
          echo "D√©ploiement sur Heroku d√©sactiv√© temporairement"

  # Job optionnel pour la gestion de l'infrastructure Lambda
  # Ce job ne s'ex√©cute que si le param√®tre "update_lambda" est sp√©cifi√© dans le workflow_dispatch
  update_lambda:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.update_lambda == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Configuration AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # V√©rification de l'existence de la fonction Lambda
      - name: V√©rification de la fonction Lambda
        id: check-lambda
        run: |
          echo "üîç V√©rification de la fonction Lambda ${{ env.LAMBDA_FUNCTION_NAME }}..."
          
          if aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} 2>/dev/null; then
            echo "‚úÖ La fonction Lambda existe d√©j√†."
            echo "LAMBDA_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå La fonction Lambda n'existe pas et ne peut pas √™tre cr√©√©e automatiquement."
            echo "LAMBDA_EXISTS=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Veuillez cr√©er manuellement la fonction Lambda via la console AWS."
            echo "‚ö†Ô∏è Nom de la fonction: ${{ env.LAMBDA_FUNCTION_NAME }}"
            echo "‚ö†Ô∏è Runtime: nodejs18.x"
            echo "‚ö†Ô∏è R√¥le: ${{ env.IAM_ROLE_NAME }}"
          fi
      
      # Mise √† jour de la fonction Lambda si elle existe d√©j√†
      - name: Mise √† jour de la fonction Lambda
        if: steps.check-lambda.outputs.LAMBDA_EXISTS == 'true'
        run: |
          echo "üîÑ Mise √† jour de la fonction Lambda..."
          
          # Cr√©ation du r√©pertoire pour la fonction Lambda
          mkdir -p lambda_function
          
          # Copie des fichiers de la fonction Lambda
          echo "üîÑ Copie des fichiers Lambda..."
          cp scripts/lambda_image_optimizer.js lambda_function/index.js
          cp scripts/lambda_package.json lambda_function/package.json
          
          # Installation des d√©pendances
          cd lambda_function
          npm install --production
          
          # Cr√©ation du package ZIP
          zip -r ../lambda_function.zip .
          cd ..
          
          # Mise √† jour de la fonction Lambda
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://lambda_function.zip
          
          echo "‚úÖ Fonction Lambda mise √† jour avec succ√®s."
      
      # Configuration du d√©clencheur S3 pour la fonction Lambda
      - name: Configuration du d√©clencheur S3
        if: steps.check-lambda.outputs.LAMBDA_EXISTS == 'true'
        run: |
          echo "üîÑ Configuration du d√©clencheur S3 pour la fonction Lambda..."
          
          # V√©rification de l'existence du bucket S3
          if aws s3api head-bucket --bucket ${{ env.S3_BUCKET }} 2>/dev/null; then
            # R√©cup√©ration de l'ARN de la fonction Lambda
            LAMBDA_ARN=$(aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Configuration.FunctionArn' --output text)
            
            # Ajout de la permission pour S3
            aws lambda add-permission \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --statement-id s3-trigger \
              --action lambda:InvokeFunction \
              --principal s3.amazonaws.com \
              --source-arn arn:aws:s3:::${{ env.S3_BUCKET }} \
              --source-account $(aws sts get-caller-identity --query 'Account' --output text) \
              2>/dev/null || true
            
            # Configuration de la notification S3
            aws s3api put-bucket-notification-configuration \
              --bucket ${{ env.S3_BUCKET }} \
              --notification-configuration '{
                "LambdaFunctionConfigurations": [
                  {
                    "LambdaFunctionArn": "'$LAMBDA_ARN'",
                    "Events": ["s3:ObjectCreated:*"],
                    "Filter": {
                      "Key": {
                        "FilterRules": [
                          {
                            "Name": "suffix",
                            "Value": ".jpg"
                          }
                        ]
                      }
                    }
                  }
                ]
              }'
            
            echo "‚úÖ D√©clencheur S3 configur√© avec succ√®s."
          else
            echo "‚ùå Le bucket S3 ${{ env.S3_BUCKET }} n'existe pas, impossible de configurer le d√©clencheur."
          fi
