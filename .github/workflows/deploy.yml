name: DÃ©ploiement FloDrama sur GitHub Pages

on:
  push:
    branches:
      - main
      - master
      - gh-pages
  workflow_dispatch:

# DÃ©finition des permissions nÃ©cessaires
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Configuration de Node.js ğŸ“¦
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'Frontend/package-lock.json'

      - name: Installation des dÃ©pendances ğŸ”§
        working-directory: ./Frontend
        run: |
          npm ci
          
      - name: Correction de la configuration Tailwind ğŸ› ï¸
        working-directory: ./Frontend
        run: |
          echo "Correction de la configuration Tailwind CSS..."
          # Simplifier postcss.config.js
          cat > postcss.config.js << 'EOL'
          module.exports = {
            plugins: {
              tailwindcss: {},
              autoprefixer: {},
            },
          }
          EOL
          
          # Mettre Ã  jour tailwind.config.js
          cat > tailwind.config.js << 'EOL'
          /** @type {import('tailwindcss').Config} */
          module.exports = {
            content: [
              './pages/**/*.{js,ts,jsx,tsx,mdx}',
              './components/**/*.{js,ts,jsx,tsx,mdx}',
              './app/**/*.{js,ts,jsx,tsx,mdx}',
              './src/**/*.{js,ts,jsx,tsx,mdx}',
            ],
            theme: {
              extend: {
                colors: {
                  'flo-blue': '#1E3A8A',
                  'flo-fuchsia': '#B91C1C',
                  'flo-violet': '#7E22CE',
                  'flo-gray': '#D1D5DB',
                },
              },
            },
            plugins: [],
          }
          EOL
          
          # Mettre Ã  jour les versions de Tailwind dans package.json
          npm install --save-dev tailwindcss@3.3.0 autoprefixer@10.4.14 postcss@8.4.21
          
      - name: Configuration des donnÃ©es S3 ğŸ“Š
        working-directory: ./Frontend
        run: |
          echo "Configuration des donnÃ©es S3..."
          mkdir -p src/config
          cat > src/config/data.ts << 'EOL'
          // src/config/data.ts
          
          // Forcer l'utilisation du S3 pour toutes les URLs de donnÃ©es
          export const BASE_DATA_URL = "https://flodrama-exported-data.s3.eu-west-3.amazonaws.com/";
          export const SEARCH_INDEX_URL = "https://flodrama-exported-data.s3.eu-west-3.amazonaws.com/index.txt";
          
          // Log pour debug
          if (typeof window !== "undefined") {
            console.log("FloDrama - Configuration de donnÃ©es:", {
              baseUrl: BASE_DATA_URL,
              searchUrl: SEARCH_INDEX_URL
            });
          }
          EOL
          
      - name: Build du projet ğŸ—ï¸
        working-directory: ./Frontend
        run: |
          echo "CrÃ©ation du build de production..."
          # VÃ©rifier que le rÃ©pertoire out n'existe pas dÃ©jÃ 
          rm -rf out
          # Construction du projet
          npm run build
          # CrÃ©er un fichier .nojekyll pour GitHub Pages
          touch out/.nojekyll
          
      - name: Copier le fichier CNAME dans le dossier de build ğŸ“‹
        run: |
          echo "Copie du fichier CNAME dans le dossier de build..."
          echo "flodrama.com" > Frontend/out/CNAME
          echo "VÃ©rification du contenu du fichier CNAME..."
          cat Frontend/out/CNAME
        
      # Utilisation de l'action officielle GitHub Pages
      - name: Configuration de GitHub Pages ğŸ”§
        uses: actions/configure-pages@v4
      
      - name: Upload des artifacts ğŸ“¤
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'Frontend/out'
      
      - name: DÃ©ploiement sur GitHub Pages ğŸš€
        id: deployment
        uses: actions/deploy-pages@v4
          
      - name: Notification de dÃ©ploiement rÃ©ussi ğŸ“¢
        run: |
          echo "ğŸ‰ FloDrama a Ã©tÃ© dÃ©ployÃ© avec succÃ¨s sur GitHub Pages!"
          echo "L'application est maintenant accessible via https://flodrama.com"
