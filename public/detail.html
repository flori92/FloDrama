<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du contenu | FloDrama</title>
    <link rel="stylesheet" href="./css/styles.css">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #d946ef;
            --background-color: #121118;
            --background-alt: #1A1926;
            --text-color: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --gradient: linear-gradient(to right, #3b82f6, #d946ef);
            --card-radius: 8px;
            --transition: 0.3s ease;
        }
        
        body {
            font-family: 'SF Pro Display', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .back-button:hover {
            color: var(--secondary-color);
        }
        
        .back-button svg {
            margin-right: 8px;
        }
        
        .content-detail {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        @media (min-width: 768px) {
            .content-detail {
                flex-direction: row;
            }
        }
        
        .content-poster {
            flex: 0 0 300px;
        }
        
        .content-poster img {
            width: 100%;
            border-radius: var(--card-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .content-info {
            flex: 1;
        }
        
        .content-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 0 10px 0;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .content-original-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin: 0 0 20px 0;
        }
        
        .content-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
        }
        
        .meta-item svg {
            margin-right: 5px;
        }
        
        .content-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .genre-tag {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 5px 15px;
            font-size: 0.9rem;
        }
        
        .content-description {
            margin-bottom: 30px;
            line-height: 1.8;
        }
        
        .content-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }
        
        .primary-button {
            background: var(--gradient);
            color: white;
            border: none;
        }
        
        .primary-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .secondary-button {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .secondary-button:hover {
            border-color: var(--secondary-color);
        }
        
        .action-button svg {
            margin-right: 8px;
        }
        
        .content-backdrop {
            width: 100%;
            height: 300px;
            background-size: cover;
            background-position: center;
            border-radius: var(--card-radius);
            margin-bottom: 30px;
            position: relative;
        }
        
        .content-backdrop::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(18, 17, 24, 0) 0%, rgba(18, 17, 24, 1) 100%);
            border-radius: var(--card-radius);
        }
        
        .content-episodes {
            margin-top: 30px;
        }
        
        .episodes-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .episodes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .episode-card {
            background: var(--background-alt);
            border-radius: var(--card-radius);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .episode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .episode-thumbnail {
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
        }
        
        .episode-info {
            padding: 15px;
        }
        
        .episode-number {
            font-weight: 600;
            margin: 0;
        }
        
        .episode-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 5px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .error-message {
            text-align: center;
            padding: 50px;
            background: var(--background-alt);
            border-radius: var(--card-radius);
            margin: 50px auto;
            max-width: 600px;
        }
        
        .error-message h2 {
            color: var(--secondary-color);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Navbar styles */
        .navbar {
            background-color: var(--background-alt);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .nav-link:hover {
            color: var(--secondary-color);
        }
        
        @media (max-width: 768px) {
            .content-title {
                font-size: 1.8rem;
            }
            
            .content-poster {
                flex: 0 0 200px;
            }
            
            .content-actions {
                flex-direction: column;
            }
            
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo">FloDrama</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Accueil</a>
                <a href="index.html?category=drama" class="nav-link">Dramas</a>
                <a href="index.html?category=movie" class="nav-link">Films</a>
                <a href="index.html?category=anime" class="nav-link">Animés</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <a href="javascript:history.back()" class="back-button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Retour
        </a>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
        </div>

        <div id="contentDetail" class="content-detail" style="display: none;">
            <!-- Content will be loaded dynamically -->
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <h2>Contenu non trouvé</h2>
            <p>Nous n'avons pas pu trouver le contenu demandé. Veuillez vérifier l'URL ou retourner à la page d'accueil.</p>
            <a href="index.html" class="action-button primary-button">Retour à l'accueil</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/imageSystemConfig.js"></script>
    <script src="js/flodrama-image-system.js"></script>
    <script src="js/content-bridge.js"></script>
    <script src="js/image-system-integration.js"></script>
    <script src="js/image-performance-monitor.js"></script>
    <script src="js/advanced-preloader.js"></script>
    <script src="js/image-diagnostic.js"></script>
    <script src="js/smart-scraping-service.js"></script>
    <script src="js/route-validator.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const contentDetailElement = document.getElementById('contentDetail');
            const loadingElement = document.getElementById('loading');
            const errorMessageElement = document.getElementById('errorMessage');
            
            // Récupérer l'ID du contenu depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');
            const action = urlParams.get('action'); // 'play' si on doit lancer la lecture
            const episodeNumber = urlParams.get('episode'); // numéro d'épisode si spécifié
            
            // Fonction pour charger les données du contenu
            async function loadContentData() {
                try {
                    // Vérifier si les données sont dans sessionStorage
                    const storedContent = sessionStorage.getItem('currentContent');
                    if (storedContent) {
                        return JSON.parse(storedContent);
                    }
                    
                    // Sinon, charger depuis le fichier JSON
                    const response = await fetch('./data/content.json');
                    if (!response.ok) {
                        throw new Error('Impossible de charger les données de contenu');
                    }
                    
                    const data = await response.json();
                    return data.items.find(item => item.id === contentId);
                } catch (error) {
                    console.error('Erreur lors du chargement des données:', error);
                    return null;
                }
            }
            
            // Fonction pour générer le HTML du contenu
            function renderContentDetail(content) {
                if (!content) {
                    loadingElement.style.display = 'none';
                    errorMessageElement.style.display = 'block';
                    return;
                }
                
                // Mettre à jour le titre de la page
                document.title = `${content.title} | FloDrama`;
                
                // Créer le HTML pour les détails du contenu
                const contentHTML = `
                    <div class="content-poster">
                        <img src="#" alt="${content.title}" id="contentPoster" data-content-id="${content.id}" data-type="poster" data-title="${content.title}" data-category="${content.category}">
                    </div>
                    <div class="content-info">
                        <h1 class="content-title">${content.title}</h1>
                        <p class="content-original-title">${content.originalTitle || ''}</p>
                        
                        <div class="content-meta">
                            <div class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M8 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${content.year}
                            </div>
                            <div class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${content.rating || '?'} / 10
                            </div>
                            <div class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${content.episodes ? `${content.episodes} épisodes` : `${content.duration || '?'} min`}
                            </div>
                            <div class="meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M2 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 2C14.5013 4.73835 15.9228 8.29203 16 12C15.9228 15.708 14.5013 19.2616 12 22C9.49872 19.2616 8.07725 15.708 8 12C8.07725 8.29203 9.49872 4.73835 12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${getCountryName(content.country)}
                            </div>
                        </div>
                        
                        <div class="content-genres">
                            ${(content.genres || []).map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                        </div>
                        
                        <div class="content-description">
                            <p>${getContentDescription(content) || 'Aucune description disponible pour le moment.'}</p>
                        </div>
                        
                        <div class="content-actions">
                            <button class="action-button primary-button" id="playButton">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 3L19 12L5 21V3Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${content.episodes ? 'Regarder' : 'Lire'}
                            </button>
                            <button class="action-button secondary-button" id="favoriteButton">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span id="favoriteButtonText">Ajouter aux favoris</span>
                            </button>
                        </div>
                        
                        ${content.episodes ? renderEpisodesList(content) : ''}
                    </div>
                `;
                
                contentDetailElement.innerHTML = contentHTML;
                contentDetailElement.style.display = 'flex';
                loadingElement.style.display = 'none';
                
                // Charger l'image du poster
                const posterImg = document.getElementById('contentPoster');
                if (posterImg && window.FloDramaImageSystem) {
                    const sources = window.FloDramaImageSystem.generateImageSources(content.id, 'poster');
                    if (sources.length > 0) {
                        posterImg.src = sources[0];
                        posterImg.addEventListener('error', function(e) {
                            window.FloDramaImageSystem.handleImageError(e);
                        });
                    }
                }
                
                // Charger l'image de backdrop si disponible
                loadBackdropImage(content.id);
                
                // Configurer les boutons
                setupButtons(content);
                
                // Vérifier si on doit lancer la lecture automatiquement
                if (action === 'play') {
                    if (episodeNumber) {
                        window.FloDramaBridge.playEpisode(content.id, parseInt(episodeNumber, 10));
                    } else {
                        window.FloDramaBridge.playContent(content.id);
                    }
                }
            }
            
            // Fonction pour configurer les boutons
            function setupButtons(content) {
                const playButton = document.getElementById('playButton');
                const favoriteButton = document.getElementById('favoriteButton');
                const favoriteButtonText = document.getElementById('favoriteButtonText');
                
                // Bouton de lecture
                if (playButton) {
                    playButton.addEventListener('click', function() {
                        window.FloDramaBridge.playContent(content.id);
                    });
                }
                
                // Bouton de favoris
                if (favoriteButton && favoriteButtonText) {
                    // Vérifier si le contenu est déjà dans les favoris
                    const isFavorite = window.FloDramaBridge.isFavorite(content.id);
                    
                    if (isFavorite) {
                        favoriteButtonText.textContent = 'Retirer des favoris';
                        favoriteButton.classList.add('active');
                    } else {
                        favoriteButtonText.textContent = 'Ajouter aux favoris';
                        favoriteButton.classList.remove('active');
                    }
                    
                    favoriteButton.addEventListener('click', function() {
                        const isNowFavorite = window.FloDramaBridge.addToFavorites(content.id);
                        
                        if (isNowFavorite) {
                            favoriteButtonText.textContent = 'Retirer des favoris';
                            favoriteButton.classList.add('active');
                        } else {
                            favoriteButtonText.textContent = 'Ajouter aux favoris';
                            favoriteButton.classList.remove('active');
                        }
                    });
                }
            }
            
            // Fonction pour charger l'image de backdrop
            function loadBackdropImage(contentId) {
                if (window.FloDramaImageSystem) {
                    const backdropContainer = document.createElement('div');
                    backdropContainer.className = 'content-backdrop';
                    backdropContainer.setAttribute('data-content-id', contentId);
                    backdropContainer.setAttribute('data-type', 'backdrop');
                    
                    const sources = window.FloDramaImageSystem.generateImageSources(contentId, 'backdrop');
                    if (sources.length > 0) {
                        backdropContainer.style.backgroundImage = `url('${sources[0]}')`;
                        
                        // Insérer avant le contenu principal
                        contentDetailElement.insertAdjacentElement('beforebegin', backdropContainer);
                        
                        // Gérer les erreurs de chargement
                        const img = new Image();
                        img.onload = function() {
                            // L'image s'est chargée correctement
                        };
                        img.onerror = function() {
                            // Essayer la source suivante
                            if (sources.length > 1) {
                                backdropContainer.style.backgroundImage = `url('${sources[1]}')`;
                            } else {
                                // Utiliser un dégradé comme fallback
                                backdropContainer.style.backgroundImage = 'linear-gradient(to right, #3b82f6, #d946ef)';
                            }
                        };
                        img.src = sources[0];
                    }
                }
            }
            
            // Fonction pour générer la liste des épisodes
            function renderEpisodesList(content) {
                if (!content.episodes || content.episodes <= 0) {
                    return '';
                }
                
                let episodesHTML = '<div class="content-episodes"><h2 class="episodes-title">Épisodes</h2><div class="episodes-list">';
                
                for (let i = 1; i <= content.episodes; i++) {
                    episodesHTML += `
                        <div class="episode-card" data-episode="${i}">
                            <div class="episode-thumbnail" style="background-image: url('#')" data-content-id="${content.id}" data-type="thumbnail" data-episode="${i}"></div>
                            <div class="episode-info">
                                <h3 class="episode-number">Épisode ${i}</h3>
                                <p class="episode-title">Épisode ${i}</p>
                            </div>
                        </div>
                    `;
                }
                
                episodesHTML += '</div></div>';
                
                return episodesHTML;
            }
            
            // Fonction pour obtenir le nom du pays à partir du code
            function getCountryName(countryCode) {
                const countries = {
                    'kr': 'Corée du Sud',
                    'jp': 'Japon',
                    'cn': 'Chine',
                    'th': 'Thaïlande',
                    'tw': 'Taïwan',
                    'in': 'Inde'
                };
                
                return countries[countryCode] || countryCode;
            }
            
            // Fonction pour générer une description si elle n'existe pas
            function getContentDescription(content) {
                if (content.description) {
                    return content.description;
                }
                
                // Générer une description basée sur les métadonnées
                const type = content.category === 'drama' ? 'drama' : 
                            content.category === 'movie' ? 'film' : 'anime';
                
                const country = getCountryName(content.country);
                const year = content.year;
                const genres = (content.genres || []).join(', ');
                
                return `${content.title} est un ${type} ${country.toLowerCase()} sorti en ${year}. 
                        ${content.episodes ? `Cette série comporte ${content.episodes} épisodes` : 
                        `Ce film dure ${content.duration || '?'} minutes`}. 
                        ${genres ? `Il s'inscrit dans les genres suivants : ${genres}.` : ''}`;
            }
            
            // Fonction pour configurer les événements après le rendu
            function setupEvents() {
                // Ajouter des événements de clic aux cartes d'épisodes
                document.querySelectorAll('.episode-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const episodeNumber = this.getAttribute('data-episode');
                        if (episodeNumber && contentId) {
                            window.FloDramaBridge.playEpisode(contentId, parseInt(episodeNumber, 10));
                        }
                    });
                });
            }
            
            // Charger les données et afficher le contenu
            if (contentId) {
                loadContentData().then(content => {
                    renderContentDetail(content);
                    setupEvents();
                });
            } else {
                loadingElement.style.display = 'none';
                errorMessageElement.style.display = 'block';
            }
        });
    </script>
</body>
</html>
